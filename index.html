<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Simple Sticky Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <style>
        #canvas .ui-selecting {
            box-shadow: 0px 0px 3px 3px #007bff;
        }

        #canvas .ui-selected {
            box-shadow: 0px 0px 3px 3px #007bff;
        }

        body {
            padding: 0;
            margin: 0;
        }

        #menu {
            padding-top: 10px;
            position: fixed;
            top: 0;
            left: 0;
            min-height: 50px;
            padding-bottom: 10px;
            background-color: white;
            border-bottom: solid 1px rgb(200, 200, 200);
        }

        #menu .row {
            max-width: 1300px;
        }

        #menu input[type='number'] {
            width: 70px;
        }

        #add-horizontal-line-button {
            background-color: white;
            padding: 0;
            height: 2rem;
            width: 2rem;
            border-width: 0.9rem 0.3rem;
        }

        #add-vertical-line-button {
            background-color: white;
            padding: 0;
            height: 2rem;
            width: 2rem;
            border-width: 0.3rem 0.9rem;
        }

        #main {
            padding: 0;
            margin: 0 auto;
            height: 0;
        }

        #card-menu-dialog .modal-body {
            padding: 0;
        }

        .canvas-item {
            cursor: grab;
        }

        .card {
            padding: 1rem 1rem 0rem 1rem;
            box-shadow: 0px 5px 10px 0px rgba(0, 0, 0, 0.4);
            border: solid 1px;
            transition: transform 500ms 0s ease;
        }

        .card:hover .card-menu-button {
            display: inline;
        }

        .card-body {
            padding: 0;
        }

        .card-body textarea {
            font-size: 48px;
            width: 12rem;
            height: 5rem;
            margin: 0;
            padding: 0;
            border: none;
            resize: none;
        }

        .sticky-note-footer {
            font-size: 0.5rem;
            background-color: rgba(0,0,0,0);
            border-top: none;
            padding: 0;
            overflow: hidden;
            height: 1rem;
            color: rgba(0,0,0,0.3);
        }

        .sticky-note-footer .row {
            margin: 0;
        }

        .sticky-note-footer div div {
            text-align: center;
            padding: 0;
        }

        .ui-draggable-dragging {
            cursor: grabbing;
        }

        #canvas {
            position: relative;
            background: linear-gradient(135deg, antiquewhite, darksalmon);
            width: 5000px;
            height: 3000px;
            overflow: hidden;
            z-index: 0;
        }

        .card-menu-button {
            display: none;
            position: absolute;
            width: 1rem;
            height: 1rem;
            right: 0.25rem;
            top: 0.25rem;
            margin: 0;
            border: none;
            cursor: pointer;
        }

        .card-menu-button {
            background-color: rgba(0,0,0,0);
            background-repeat: no-repeat;
        }

        .tooltip div {
            font-size: 1rem;
            opacity: 0.8;
        }

        .line {
            background-color:rgba(0,0,0,0.3);
        }

        .horizontal-line {
            width: 1000px;
            height: 1rem;
        }

        .vertical-line {
            width: 1rem;
            height: 1000px;
        }

        #image-load-area img {
            width: 100%;
        }

        .canvas-item.image {
            width: 14em;
            box-shadow: 0px 5px 10px 0px rgba(0, 0, 0, 0.4);
            padding: 0;
            opacity: 0.8;
        }

        .canvas-item.image img {
            width: 100%;
            height: 100%;
        }

        /* colors */

        .color-red,
        .color-red .card-body textarea {
            background-color: rgba(255, 200, 255, 1);
            border-color: rgba(200, 150, 200, 1);
        }

        .color-red .card-menu-button {
            background-image: url('https://mdbootstrap.com/img/svg/hamburger6.svg?color=a33');
        }

        .color-blue,
        .color-blue .card-body textarea {
            background-color: rgba(150, 200, 255, 1);
            border-color: rgba(100, 150, 200, 1);
        }

        .color-blue .card-menu-button {
            background-image: url('https://mdbootstrap.com/img/svg/hamburger6.svg?color=33a');
        }

        .color-green,
        .color-green .card-body textarea {
            background-color: rgba(200, 255, 200, 1);
            border-color: rgba(150, 200, 150, 1);
        }

        .color-green .card-menu-button {
            background-image: url('https://mdbootstrap.com/img/svg/hamburger6.svg?color=3a3');
        }

        .color-yellow,
        .color-yellow .card-body textarea {
            background-color: rgba(255, 255, 200, 1);
            border-color: rgba(200, 200, 150, 1);
        }

        .color-yellow .card-menu-button {
            background-image: url('https://mdbootstrap.com/img/svg/hamburger6.svg?color=aa3');
        }

        .color-white,
        .color-white .card-body textarea {
            background-color: rgba(255, 255, 255, 1);
            border-color: rgba(150, 150, 150, 1);
        }

        .color-white .card-menu-button {
            background-image: url('https://mdbootstrap.com/img/svg/hamburger6.svg?color=aaa');
        }

        .color-transparent,
        .color-transparent .card-body textarea {
            background-color: unset;
            border-color: rgba(0, 0, 0, 0.3);
        }

        .color-transparent .card-menu-button {
            background-image: url('https://mdbootstrap.com/img/svg/hamburger6.svg?color=aaa');
        }

        .color-transparent.card {
            box-shadow: unset;
        }

        /* colors end */

    </style>
</head>

<body>

    <div id="main" class="container-fluid">
        <div id="canvas"></div>
    </div>

    <div id="menu" class="container-fluid">
        <div class="row">
            <div class="col-sm-2">
                <div>File</div>
                <button id="export-button" class="btn btn-success btn-sm">export</button>
                <button id="import-button" class="btn btn-primary btn-sm">import</button>
            </div>
            <div class="col-sm-2">
                <div>Card</div>
                <select id="color-selection" class="">
                    <option value="" selected>Choose...</option>
                    <option value="red" class="color-red">Red</option>
                    <option value="blue" class="color-blue">Blue</option>
                    <option value="green" class="color-green">Green</option>
                    <option value="yellow" class="color-yellow">Yellow</option>
                    <option value="white" class="color-white">White</option>
                    <option value="transparent">Transparent</option>
                </select>
                <button id="add-button" class="btn btn-primary btn-sm">add</button>
            </div>
            <div class="col-sm-1">
                <div>Line</div>
                <button id="add-horizontal-line-button" class="btn btn-primary btn-sm">&nbsp;</button>
                <button id="add-vertical-line-button" class="btn btn-primary btn-sm">&nbsp;</button>
            </div>
            <div class="col-sm-1">
                <div>Image</div>
                <button id="add-image-button" class="btn btn-primary btn-sm">add</button>
            </div>
            <div class="col-sm-2">
                <div>Edit</div>
                <button id="delete-item-button" class="btn btn-danger btn-sm">delete</button>
                <button id="return-button" class="btn btn-primary btn-sm">return</button>
            </div>
            <div class="col-sm-2">
                <div class="">Zoom</div>
                <div class="btn-group">
                    <button id="zoom-in-button" class="btn btn-secondary btn-sm">in</button>
                    <button id="zoom-out-button" class="btn btn-secondary btn-sm">out</button>
                    <button id="zoom-fit-button" class="btn btn-secondary btn-sm">fit</button>
                    <button id="zoom-reset-button" class="btn btn-secondary btn-sm">reset</button>
                </div>
            </div>
            <div class="col-sm-2">
                <div>Canvas size</div>
                <input type="number" id="canvas-width" />
                <input type="number" id="canvas-height" />
                <button id="set-canvas-size-button" class="btn btn-secondary btn-sm">set</button>
            </div>
        </div>
    </div>

    <div id="card-menu-dialog" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Card action</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <label for="card-menu-color-selection">Color</label>
                            <select id="card-menu-color-selection">
                                <option value="" selected>Choose...</option>
                                <option value="red" class="color-red">Red</option>
                                <option value="blue" class="color-blue">Blue</option>
                                <option value="green" class="color-green">Green</option>
                                <option value="yellow" class="color-yellow">Yellow</option>
                                <option value="white" class="color-white">White</option>
                                <option value="transparent">Transparent</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div id="add-image-dialog" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add image</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="image-file-selection">
                        <label class="custom-file-label" for="image-file-selection">Choose file</label>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div id="card-template" class="d-none card sticky-note canvas-item" data-toggle="tooltip" data-placement="top">
        <button class="card-menu-button"></button>
        <div class="card-body">
            <textarea></textarea>
        </div>
        <div class="sticky-note-footer container-fluid">
            <div class="row">
                <div class="col-sm-4"></div>
                <div class="col-sm-4"></div>
                <div class="col-sm-4"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cuid/1.3.8/browser-cuid.min.js"></script>
    <script>

        let scaleStep = 0.1;
        var currentScale = 1.0;
        var selectedCardId = null;
        let deletedCardIds = new Array();

        var click = {
            x: 0,
            y: 0
        };

        // for scalable select..
        let oldOuterWidth = $.fn.outerWidth;
        let oldOuterHeight = $.fn.outerHeight;

        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
            $("#add-button").on("click", add);
            $("#return-button").on("click", returnCard);
            $("#zoom-in-button").on("click", zoomIn);
            $("#zoom-out-button").on("click", zoomOut);
            $("#zoom-fit-button").on("click", zoomFitWidth);
            $("#zoom-reset-button").on("click", zoomReset);
            $("#set-canvas-size-button").on("click", setCanvasSize);
            $("#delete-item-button").on("click", deleteItem);
            $("#add-horizontal-line-button").on("click", addHorizonalLine);
            $("#add-vertical-line-button").on("click", addVerticalLine);
            $("#add-image-button").on("click", (e) => {
                $("#add-image-dialog").modal();
            });
            $("#export-button").on("click", exportData);
            $("#import-button").on("click", importData);
            $(document).on("paste", addImageFromClipboard);
            toSelectable($("#canvas"));

            // card menu dialog.
            $("#card-menu-dialog").on("hide.bs.modal", () => {
                selectedCardId = null;
            });
            $("#card-menu-dialog").on("hidden.bs.modal", () => {
                $("#card-menu-color-selection").val("");
            });
            $("#card-menu-color-selection").on("change", (e) => {
                changeColor(getEditTargetCards(), $(e.target).val());
                $("#card-menu-dialog").modal("hide");
            });

            // add image dialog
            $("#image-file-selection").on("change", loadImageFromLocal);
            $("#add-image-dialog").on("show.bs.modal", () => {
                $("#image-file-selection").next().text("Choose file");
                $("#image-load-area").html("no image.");
            });
            $("#add-image-item-button").on("click", addImageItemFromModal);

            // initialize width & height.
            $("#canvas-width").val($("#canvas").width());
            $("#canvas-height").val($("#canvas").height());

            // initialize margin of main.
            adjustMainMarginTop();
            $(window).on("resize", adjustMainMarginTop);
            $(window).on("resize", applyScale);

            // setup conrifm
            $(window).on('beforeunload', function (event) {
                console.log(".");
                return 'jquery beforeunload';
            });
        });

        function add() {

            let color = $("#color-selection").val();
            if (color == "") {
                color = "yellow";
            }
            let cardId = cuid();
            let card = $("#card-template").clone();
            let cardMenuButton = $(card).find("button");
            let cardTextarea = $(card).find("textarea");

            cardMenuButton.on("click", (e) => {
                selectedCardId = cardId;
                $("#card-menu-dialog").modal();
            });

            $(cardTextarea).on("change", (e) => {
                $(card).tooltip("dispose");
                $(card).tooltip({ title: $(e.target).val() });
            });

            $(cardTextarea).on("keyup", (e) => {
                // escape key.
                if (e.keyCode == 27) {
                    cardTextarea.blur();
                }
            });

            $(cardTextarea).on("focus", (e) => {
                // auto expand.
                if (1 <= currentScale) {
                    return;
                }
                $(card)
                    .css("transform-origin", "left top")
                    .css("transform", "scale(" + (1 / currentScale) + ")");
            });

            $(cardTextarea).on("blur", (e) => {
                // return expand.
                setTimeout(() => {
                    $(card)
                        .css("transform-origin", "none")
                        .css("transform", "none");
                }, 500);//for car menu button.
            });

            toFontSizeAdjustable(cardTextarea);

            card.attr("id", cardId);
            card.removeClass("d-none");
            card.addClass("card");
            card.addClass("color-" + color);

            initializePosition(card);
            toFrontMostItem(card);

            card.on("mousedown", (e) => {
                toFrontMostItem($(card));
            });

            // add from this card on double clik .
            $(card).on("dblclick", (e) => {
                addStickyNoteFrom(card);
            });

            $("#canvas").append(card);

            toDraggable(card);

            $(cardTextarea).attr("data-scroll-height", $(cardTextarea)[0].scrollHeight);

            return card;
        }

        function addHorizonalLine() {
            addLine(false);
        }

        function addVerticalLine() {
            addLine(true);
        }

        function addLine(isVertical) {
            let lineId = cuid();
            var line = $("<div></div>");
            line.addClass("line canvas-item");
            line.addClass(isVertical ? "vertical-line" : "horizontal-line");
            line.attr("id", lineId);
            line.removeClass("d-none");
            initializePosition(line);
            toFrontMostItem(line);
            let handles = isVertical ? "s" : "e";
            line.resizable({
                handles: handles,
                resize: function (event, ui) {
                    if (isVertical) {
                        let length = ui.originalSize.height + ((ui.size.height - ui.originalSize.height) / currentScale);
                        $(line).height(length);
                    } else {
                        let length = ui.originalSize.width + ((ui.size.width - ui.originalSize.width) / currentScale);
                        $(line).width(length);
                    }
                }
            });

            line.on("mousedown", (e) => {
                toFrontMostItem($(line));
            });

            // add from this line on double clik .
            $(line).on("dblclick", (e) => {
                addLineFrom(line);
            });

            $("#canvas").append(line);
            toDraggable(line);
            return line;
        }

        function addImageItemFromModal() {
            if ($("#image-load-area img").length == 0) {
                return;
            }
            const base64Url = $("#image-load-area img").attr("src");
            addImage(base64Url);
            $("#add-image-dialog").modal("hide");
        }

        function addImage(base64Url) {
            const imageId = cuid();
            const image = $("<div></div>");
            $(image).attr("id", imageId);
            $(image).addClass("image canvas-item")
            $(image).html("<img src='" + base64Url + "'>");
            initializePosition(image);

            toFrontMostItem(image);
            image.on("mousedown", (e) => {
                toFrontMostItem($(image));
            });
            $(image).resizable({
                alsoResize: ".canvas-item.image.ui-selected",
                aspectRatio: true,
                resize: function (event, ui) {
                    let height = ui.originalSize.height + ((ui.size.height - ui.originalSize.height) / currentScale);
                    $(image).height(height);
                    let width = ui.originalSize.width + ((ui.size.width - ui.originalSize.width) / currentScale);
                    $(image).width(width);
                }
            });
            $("#canvas").append(image);
            toDraggable(image);
            return image;
        }

        function addImageFromClipboard(event) {
            var items = event.originalEvent.clipboardData.items;
            for (var i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf("image") != -1) {
                    const file = item.getAsFile();
                    readFileAsBase64Url(file, (dataUrl) => {
                        addImage(dataUrl);
                    });
                }
            }
        }

        function initializePosition(item) {
            let scrollX = window.scrollX / currentScale;
            let scrollY = window.scrollY / currentScale;
            item.css("top", scrollY + 30 + "px");
            item.css("left", scrollX + 30 + "px");
        }

        function toFrontMostItem(target) {
            let targetIndex = parseInt($(target).css("z-index"));
            var maxIndex = 0;
            $(".canvas-item").each((i, v) => {
                if ($(v) == $(target)) {
                    return;
                }
                let myIndex = parseInt($(v).css("z-index"));
                maxIndex = Math.max(maxIndex, myIndex);
                if (myIndex > targetIndex) {
                    $(v).css("z-index", myIndex - 1);
                }
            });
            $(target).css("z-index", maxIndex);
        }

        function addStickyNoteFrom(from) {
            let target = $(from).attr("id") ? $(from) : $(from).parents(".sticky-note");
            let added = add();
            let sourceLeft = parseFloat($(target).css("left"));
            let sourceTop = parseFloat($(target).css("top"));
            let colorClass = findFirstClass(target, (className) => className.startsWith("color-"));
            changeColor(added, colorClass ? colorClass.substring(6) : "color-yellow");
            added.css("left", sourceLeft + 5 + "px");
            added.css("top", sourceTop + 5 + "px");
        }

        function addLineFrom(from) {
            let target = $(from).attr("id") ? $(from) : $(from).parents(".line");
            let isVertical = $(target).hasClass("vertical-line");
            let added = addLine(isVertical);
            let sourceLeft = parseFloat($(target).css("left"));
            let sourceTop = parseFloat($(target).css("top"));
            added.css("left", sourceLeft + 5 + "px");
            added.css("top", sourceTop + 5 + "px");
            if (isVertical) {
                added.height($(target).height());
            } else {
                added.width($(target).width());
            }
        }

        function findFirstClass(target, filterFunction) {
            let filtered = $(target).attr("class").split(" ").filter((val) => {
                return filterFunction(val);
            });
            let result = filtered.length == 0 ? null : filtered[0];
            return result;
        }

        function toDraggable(item) {
            $(item).css("position", "absolute");
            // In the case of zoom-in / zoom-out, since the position of the drag shifts, it is necessary to adjust it.
            // see https://stackoverflow.com/questions/13882070/jquery-draggable-and-webkit-transform-scale
            $(item).draggable({
                stack: ".canvas-item",
                start: function (event) {
                    click.x = event.clientX;
                    click.y = event.clientY;
                    $(".ui-selected").each((i, selected) => {
                        $(selected).attr("startX", parseInt($(selected).css("left")));
                        $(selected).attr("startY", parseInt($(selected).css("top")));
                    });
                    // dispose tooltip.
                    if ($(event.target).hasClass("sticky-note")) {
                        $(event.target).tooltip("dispose");
                    }
                },
                drag: function (event, ui) {
                    // This is the parameter for scale()
                    var zoom = currentScale;

                    var original = ui.originalPosition;

                    // jQuery will simply use the same object we alter here
                    ui.position = {
                        left: (event.clientX - click.x + original.left) / zoom,
                        top: (event.clientY - click.y + original.top) / zoom
                    };

                    if (!$(event.target).hasClass("ui-selected")) {
                        return;
                    }

                    let moveX = original.left / zoom - ui.position.left;
                    let moveY = original.top / zoom - ui.position.top;

                    // move selected item.
                    $(".ui-selected").each((i, selected) => {
                        if (!$(event.target) == selected) {
                            return;
                        }
                        $(selected).css("left", ($(selected).attr("startX") - moveX) + "px");
                        $(selected).css("top", ($(selected).attr("startY") - moveY) + "px");
                    });
                },
                stop: function (event) {
                    // enable tooltip.
                    if ($(event.target).hasClass("sticky-note")) {
                        $(event.target).tooltip({ title: $(event.target).find("textarea").val() });
                    }
                }
            });
        }

        function toSelectable(canvas) {
            $(canvas).selectable({
                filter: ".canvas-item",
                start: (e, ui) => {
                    $(".sticky-note textarea").blur();
                }
            });
            // for scaleable select.
            $.fn.outerWidth = function () {
                var w = oldOuterWidth.apply($(this));
                if ($(this).hasClass("canvas-item")
                    && $(this).hasClass("ui-selectee")) {
                    return w * currentScale;
                } else {
                    return w;
                }
            };
            $.fn.outerHeight = function () {
                var h = oldOuterHeight.apply($(this));
                if ($(this).hasClass("canvas-item")
                    && $(this).hasClass("ui-selectee")) {
                    return h * currentScale;
                } else {
                    return h;
                }
            };
        }

        function toFontSizeAdjustable(textarea) {
            const minFontSize = 12;
            const maxFontSize = 48;

            const toSmall = function () {
                const fontSize = parseFloat($(textarea).css("font-size"));
                if (fontSize <= minFontSize) {
                    return;
                }
                const minScrollHeight = $(textarea).attr("data-scroll-height");
                if (minScrollHeight >= $(textarea)[0].scrollHeight) {
                    return;
                }
                $(textarea).css("font-size", (fontSize - 1) + "px");
                toSmall();
            };

            const toBig = function () {
                const fontSize = parseFloat($(textarea).css("font-size"));
                if (fontSize >= maxFontSize) {
                    return;
                }
                $(textarea).css("font-size", (fontSize + 1) + "px");
                adjustFontSize();
            };

            const adjustFontSize = function () {
                const minScrollHeight = $(textarea).attr("data-scroll-height");
                const currentScrollHeight = $(textarea)[0].scrollHeight;
                if (minScrollHeight < currentScrollHeight) {
                    toSmall();
                } else {
                    toBig();
                }
            };

            $(textarea).on("keydown", adjustFontSize);
        }

        function zoomIn() {
            currentScale = currentScale + (currentScale * scaleStep);
            applyScale();
        }

        function zoomOut() {
            currentScale = currentScale - (currentScale * scaleStep);
            applyScale();
        }

        function zoomFitWidth() {
            currentScale = window.innerWidth / $("#canvas").width();
            scrollTo(0, 0);
            applyScale();
        }
        function zoomReset() {
            currentScale = 1;
            applyScale();
        }

        function applyScale() {
            // do nothing while resizing.
            if ($(".ui-resizable-resizing").length > 0) {
                return;
            }
            if ($(".ui-selected").length == 0) {
                let scrollLeft = $(window).scrollLeft();
                let scrollTop = $(window).scrollTop();
                let beforeDocumentWidth = $(document).width();
                let beforeDocumentHeight = $(document).height();
                $("#canvas")
                    .css("transform", "scale(" + currentScale + ")")
                    .css("transform-origin", "left top");
                $(window).scrollLeft($(document).width() * (scrollLeft / beforeDocumentWidth));
                $(window).scrollTop(($(document).height()) * (scrollTop / beforeDocumentHeight));
            } else {
                let selecteds = $(".canvas-item.ui-selected");
                var mostLeft = Math.min.apply(null, $.map(selecteds, x => parseInt($(x).css("left"))));
                var mostTop = Math.min.apply(null, $.map(selecteds, x => parseInt($(x).css("top"))));
                $("#canvas")
                    .css("transform", "scale(" + currentScale + ")")
                    .css("transform-origin", "left top");;
                $(window).scrollLeft(mostLeft * currentScale - (30 * currentScale));
                $(window).scrollTop(mostTop * currentScale - (30 * currentScale));
            }
        }

        function setCanvasSize() {
            let w = $("#canvas-width").val();
            let h = $("#canvas-height").val();
            $("#canvas").width(w).height(h);
        }

        function changeColor(targets, color) {
            let colors = $("#card-menu-color-selection").find("option").each((i, v) => {
                targets.removeClass("color-" + $(v).val());
            });
            targets.addClass("color-" + color);
        }

        function deleteItem() {
            let targets = $(".ui-selected");
            $(targets).hide({
                done: (target) => {
                    $(target.elem).removeClass("ui-selected");
                    deletedCardIds.push($(target.elem).attr("id"));
                }
            });
        }

        function getEditTargetCards() {
            if ($("#" + selectedCardId + ".ui-selected.sticky-note").length == 1) {
                return $(".ui-selected.sticky-note");
            } else {
                return $("#" + selectedCardId);
            }
        }

        function returnCard() {
            let cardId = deletedCardIds.pop();
            $("#" + cardId).show("middle");
        }

        function adjustMainMarginTop() {
            $("#canvas").css("margin-top", $("#menu").innerHeight());
        }

        function loadImageFromLocal(event) {
            if (event.target.files.length == 0) {
                return;
            }
            const file = event.target.files[0];
            if (!file.type.startsWith("image")) {
                return;
            }

            readFileAsBase64Url(file, (dataUrl) => {
                addImage(dataUrl);
                event.target.value = null;
                $("#add-image-dialog").modal("hide");
            });
        }

        function readFileAsBase64Url(file, callback) {
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                var dataUrl = reader.result;
                callback(dataUrl);
            }
        }

        function exportData() {
            const obj = {
                canvas: {
                    width: $("#canvas-width").val(),
                    height: $("#canvas-height").val()
                },
                items: []
            };
            $(".canvas-item:visible").each(function (i, elem) {
                obj.items[i] = convertToDataForExport(elem);
            });
            const json = JSON.stringify(obj);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([json], { type: 'text/json' }));
            a.download = "simple-sticky-note_" + getCurrentDatetimeString() + ".json";
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData() {
            const input = document.createElement('input')
            input.type = "file";
            input.addEventListener("change", function (event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.readAsText(file);
                reader.onloadend = function () {
                    var json = reader.result;
                    importDataFromJson(json);
                };
            });
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);


        }

        function getCurrentDatetimeString() {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours();
            const minute = date.getMinutes();
            const second = date.getSeconds();
            return zeroPadding(year, 4) +
                zeroPadding(month, 2) +
                zeroPadding(day, 2) +
                zeroPadding(hour, 2) +
                zeroPadding(minute, 2) +
                zeroPadding(second, 2)
        }

        function zeroPadding(num, length) {
            const str = num.toString();
            const addLen = str.length < length ? length - str.length : 0;
            const sliceLen = str.length < length ? length : str.length;
            var preZeros = "";
            for (var i = 0; i < addLen; i++) {
                preZeros = preZeros + "0";
            }
            return (preZeros + num).slice(-sliceLen);
        }

        function convertToDataForExport(elem) {
            if ($(elem).hasClass("sticky-note")) {
                return convertToStikyNoteDataForExport(elem);
            } else if ($(elem).hasClass("vertical-line")) {
                return convertToVerticalLineDataForExport(elem);
            } else if ($(elem).hasClass("horizontal-line")) {
                return convertToHorizontalLineDataForExport(elem);
            } else if ($(elem).hasClass("image")) {
                return convertToImageDataForExport(elem);
            }
            return null;
        }

        function convertToStikyNoteDataForExport(elem) {
            $e = $(elem);
            const colorClass = findFirstClass($e, (className) => className.startsWith("color-"));
            return {
                type: "sticky-note",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                zIndex: $e.css("z-index"),
                text: $e.find("textarea").val(),
                color: colorClass
            };
        }

        function drawStickyNoteFromData(data) {
            var item = add();
            $(item)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .css("z-index", data.zIndex)
                .removeClass("color-yellow")
                .addClass(data.color)
                .find("textarea").val(data.text);
            $(item).tooltip({ title: data.text });
            $(item).find("textarea").trigger("keydown");
        }

        function convertToVerticalLineDataForExport(elem) {
            $e = $(elem);
            return {
                type: "vertical-line",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                zIndex: $e.css("z-index"),
                length: $e.height()
            };
        }

        function drawVerticalLineFromData(data) {
            var line = addLine(true);
            $(line)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .css("z-index", data.zIndex)
                .height(data.length);
        }

        function convertToHorizontalLineDataForExport(elem) {
            $e = $(elem);
            return {
                type: "horizontal-line",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                zIndex: $e.css("z-index"),
                length: $e.width()
            };
        }

        function drawHorizontalLineFromData(data) {
            var line = addLine(false);
            $(line)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .css("z-index", data.zIndex)
                .width(data.length);
        }

        function convertToImageDataForExport(elem) {
            $e = $(elem);
            return {
                type: "image",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                width: $e.width(),
                height: $e.height(),
                zIndex: $e.css("z-index"),
                src: $e.find("img").attr("src")
            };
        }

        function drawImageFromData(data) {
            var line = addImage(data.src);
            $(line)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .width(data.width)
                .height(data.height)
                .css("z-index", data.zIndex);
        }

        function importDataFromJson(json) {
            const obj = JSON.parse(json);

            $(".canvas-item:visible").remove();

            $("#canvas-width").val(obj.canvas.width);
            $("#canvas-height").val(obj.canvas.height);
            setCanvasSize();
            zoomFitWidth();

            for (var i = 0; i < obj.items.length; i++) {
                const data = obj.items[i];
                if (data.type == "sticky-note") {
                    drawStickyNoteFromData(data);
                } else if (data.type == "vertical-line") {
                    drawVerticalLineFromData(data);
                } else if (data.type == "horizontal-line") {
                    drawHorizontalLineFromData(data);
                } else if (data.type == "image") {
                    drawImageFromData(data);
                }
            }
        }

    </script>
</body>

</html>