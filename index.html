<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Demo of Simple Sticky Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css"
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <style>
        html {
            font-size: 14px;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding: 0;
            margin: 0;
        }

        .ui-selectable-helper {
            background-color: #aaaaaa;
            opacity: 0.5;
        }

        #menu {
            padding-left: -10px;
            padding-top: 10px;
            position: fixed;
            top: 0;
            left: 0;
            min-height: 50px;
            padding-bottom: 10px;
            background-color: white;
            border-bottom: solid 1px rgb(200, 200, 200);
        }

        #menu a {
            cursor: pointer;
        }

        #menu>.row {
            max-width: 1500px;
        }

        #menu input[type='number'] {
            width: 70px;
        }

        #menu .btn-group>button {
            font-size: 14px;
            height: 31px;
            padding-top: 4px;
            padding-bottom: 4px;
        }

        #menu .fas {
            margin-left: -19px;
            margin-right: 5px;
        }

        #menu .fab {
            margin-left: -19px;
            margin-right: 5px;
            font-size: 0.8rem;
        }

        #zoom-in-button {
            font-weight: bold;
        }

        #zoom-out-button {
            font-weight: bold;
        }

        #main {
            padding: 0;
            margin: 0 auto;
            height: 0;
        }

        #card-menu-dialog .modal-body {
            padding: 0;
        }

        .canvas-item {
            cursor: grab;
        }

        #canvas .canvas-item:hover {
            box-shadow: 0px 0px 3px 3px #1ad2df;
        }

        #canvas .canvas-item.ui-selecting {
            box-shadow: 0px 0px 3px 3px #1ad2df;
        }

        #canvas .canvas-item.ui-selected {
            box-shadow: 0px 0px 3px 3px #007bff;
        }

        .card {
            padding: 5px;
            height: 60px;
            width: 120px;
            border: solid 1px;
            transition: transform 500ms 0s ease;
        }

        .sticky-note-header {
            height: 1rem;
            display: none;
        }

        .sticky-note-body {
            padding: 0;
            height: 100%;
            position: relative;
        }

        .sticky-note-body textarea {
            position: absolute;
            /* Edge 対応 */
            font-size: 24px;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: none;
            resize: none;
            overflow-y: none;
            -ms-overflow-style: none;
            /* IE, Edge 対応 */
            scrollbar-width: none;
            /* Firefox 対応 */
        }

        .sticky-note-body textarea::-webkit-scrollbar {
            width: 0;
        }

        .sticky-note-body .textarea-cover {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
        }

        .sticky-note-footer {
            font-size: 0.5rem;
            background-color: rgba(0, 0, 0, 0);
            border-top: none;
            padding: 0;
            overflow: hidden;
            height: 1rem;
            color: rgba(0, 0, 0, 0.3);
            display: none;
        }

        .sticky-note-footer .row {
            margin: 0;
        }

        .sticky-note-footer div div {
            text-align: center;
            padding: 0;
        }

        #canvas {
            position: relative;
            background: linear-gradient(135deg, rgb(247, 237, 225), rgb(212, 80, 36));
            width: 5000px;
            height: 3000px;
            overflow: hidden;
            z-index: 0;
        }

        .canvas-item .menuset {
            display: none;
            position: absolute;
            top: 0px;
            right: -28px;
            width: 20px;
            font-size: 10px;
            margin: 0 0.5rem 0 auto;
            background-color: #007bff;
            border-radius: 0px 5px 5px 5px;
            color: #ffffff;
        }

        .canvas-item.horizontal-line .menuset {
            top: 1rem;
            right: -8px;
            border-radius: 0px 0px 5px 5px;
        }

        .canvas-item:hover .menuset {
            display: block;
        }

        .canvas-item .menuset * {
            display: block;
            padding: 7px 5px 7px 5px;
        }

        .canvas-item .menuset *:hover {
            background-color: #0062cc;
            border-radius: inherit;
        }

        .canvas-item:hover .menuset * {
            cursor: pointer;
        }

        .tooltip {
            display: none;
        }

        .line {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .horizontal-line {
            width: 1000px;
            height: 1rem;
        }

        .vertical-line {
            width: 1rem;
            height: 1000px;
        }

        #image-load-area img {
            width: 100%;
        }

        .canvas-item.image {
            padding: 0;
            opacity: 1;
        }

        .canvas-item.image img {
            width: 100%;
            height: 100%;
        }

        .pointer {
            width: 10px;
            height: 10px;
            border-radius: 10px;
            background-color: red;
            opacity: 0.5;
            white-space: nowrap;
        }

        .pointer .name {
            position: absolute;
            margin: -7px 0 0 10px;
        }

        input.user-name {
            font-size: 0.9em;
            width: 75px;
        }

        .markdown {
            width: 400px;
            height: 300px;
            padding: 0px 10px 10px 10px;
            border: solid 1px black;
            overflow: none;
            min-width: 200px;
            min-height: 100px;
            background-color: white;
            border-color: silver;
        }

        .markdown .markdown-header {
            height: 10px;
        }

        .markdown .nav-item.spacer {
            width: calc(100% - 5em);
        }

        .markdown .md-editor {
            width: auto;
            height: 100%;
        }

        .markdown .md-editor textarea {
            margin-top: 5px;
            resize: none;
            width: 100%;
            height: calc(100% - 5px);
            background-color: rgba(0, 0, 0, 0);
            border: solid 1px silver;
        }

        .markdown .tab-content {
            word-break: break-all;
            width: 100%;
            overflow-y: hidden;
            height: calc(100% - 33px);
        }

        .markdown .nav-tabs a {
            font-size: 0.8em;
            padding: .3rem .3rem;
        }

        .markdown .md-view table {
            border: solid 1px;
        }

        .markdown .md-view table {
            border-collapse: collapse;
        }

        .markdown .md-view table th {
            border: solid 1px black;
            background-color: silver;
            color: white;
            font-weight: normal;
            padding: 5px;
        }

        .markdown .md-view table td {
            border: solid 1px;
            padding: 5px;
        }

        [data-notify="container"][class*="alert"] {
            width: 210px;
            overflow: hidden;
            font-size: 30px;
            padding: 3px 14px;
        }

        [data-notify="icon"] {
            font-size: 30px;
        }

        .close {
            font-size: 12px;
        }

        textarea.editing {
            background-color: rgba(200, 200, 200, 0.4) !important;
        }

        input[type="text"],
        input[type="password"],
        button,
        textarea,
        select {
            outline: none;
        }

        .markdown a[target="_blank"]:after {
            content: "\f35d";
            margin: 0 3px 0 2px;
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            font-size: 0.7rem;
        }

        #create-url-dialog .modal-body textarea {
            height: 10rem;
            max-height: 10rem;
        }

        #reaction-buttons {
            position: fixed;
            top: 10px;
            right: 10px;
            opacity: 0.3;
        }

        #reaction-buttons:hover {
            opacity: 1;
        }

        #reaction-buttons button {
            font-size: 30px;
        }

        /* colors */

        .sticky-note {
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .color-red,
        .color-red .sticky-note-body textarea {
            background-color: rgba(255, 200, 255, 1);
        }

        .color-blue,
        .color-blue .sticky-note-body textarea {
            background-color: rgba(150, 200, 255, 1);
        }

        .color-green,
        .color-green .sticky-note-body textarea {
            background-color: rgba(200, 255, 200, 1);
        }

        .color-yellow,
        .color-yellow .sticky-note-body textarea {
            background-color: rgba(255, 255, 200, 1);
        }

        .color-white,
        .color-white .sticky-note-body textarea {
            background-color: rgba(255, 255, 255, 1);
        }

        .color-transparent,
        .color-transparent .sticky-note-body textarea {
            background-color: unset;
            border-color: rgba(0, 0, 0, 0);
        }

        .color-transparent.card:hover {
            box-shadow: unset;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        /* colors end */
    </style>
</head>

<body>

    <div id="main" class="container-fluid">
        <div id="canvas"></div>
    </div>

    <div id="menu" class="container-fluid">
        <div class="row">
            <div class="col-sm-2 container-fluid">
                <div>メニュー</div>
                <div class="btn-group" role="group">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            ファイル
                        </button>
                        <div class="dropdown-menu">
                            <a id="export-button" class="dropdown-item"><span
                                    class="fas fa-file-export"></span>エクスポート</a>
                            <a id="import-button" class="dropdown-item"><span
                                    class="fas fa-file-import"></span>インポート</a>
                            <a id="create-url-button" class="dropdown-item"><span class="fas fa-link"></span>URLを生成</a>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            追加
                        </button>
                        <div class="dropdown-menu">
                            <a id="add-narrative-arc-button" class="dropdown-item"><span
                                    class="fab fa-think-peaks"></span>ストーリー</a>
                            <a id="add-button" class="dropdown-item"><span class="fas fa-sticky-note"></span>付箋</a>
                            <a id="add-markdown-button" class="dropdown-item"><span
                                    class="fab fa-markdown"></span>マークダウン</a>
                            <a id="add-image-button" class="dropdown-item"><span class="fas fa-image"></span>画像</a>
                            <a id="add-horizontal-line-button" class="dropdown-item"><span
                                    class="fas fa-minus"></span>横線</a>
                            <a id="add-vertical-line-button" class="dropdown-item"><span
                                    class="fas fa-minus fa-rotate-90"></span>縦線</a>
                            <input type="file" id="image-file-selection" hidden>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            編集
                        </button>
                        <div class="dropdown-menu">
                            <a id="undo-button" class="dropdown-item"><span class="fas fa-undo"></span>元に戻す</a>
                            <a id="redo-button" class="dropdown-item"><span class="fas fa-redo"></span>やり直し</a>
                            <a id="send-to-front-button" class="dropdown-item"><span
                                    class="fas fa-chevron-up"></span>最前面に移動</a>
                            <a id="send-to-back-button" class="dropdown-item"><span
                                    class="fas fa-chevron-down"></span>最背面に移動</a>
                            <a id="delete-item-button" class="dropdown-item bg-danger text-white"><span
                                    class="fas fa-trash-alt"></span>削除</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="">共同作業
                </div>
                <input id="user-name" class="user-name d-none" type="text" placeholder="名前"" />
                <button id="create-room-button" class="btn btn-secondary btn-sm">部屋を作成</button>
                <button id="push-button" class="btn btn-warning btn-sm d-none">表示内容をプッシュ</button>
                <button id="clear-pointers-button" class="btn btn-secondary btn-sm d-none">ポインタを削除</button>
            </div>
            <div class="col-sm-3">
                <div class="">ズーム</div>
                <div class="">
                    <button id="zoom-in-button" class="btn btn-secondary btn-sm">＋</button>
                    <button id="zoom-out-button" class="btn btn-secondary btn-sm">ー</button>
                    <button id="zoom-fit-button" class="btn btn-secondary btn-sm">横幅に合わせる</button>
                    <button id="zoom-reset-button" class="btn btn-secondary btn-sm">リセット</button>
                </div>
            </div>
            <div class="col-sm-2">
                <div>キャンバスサイズ</div>
                <input type="number" id="canvas-width" placeholder="横幅" />
                <input type="number" id="canvas-height" placeholder="高さ" />
                <button id="set-canvas-size-button" class="btn btn-secondary btn-sm">設定</button>
            </div>
        </div>
    </div>

    <div id="reaction-buttons" class="btn-group d-none">
        <button id="call-button" class="btn btn-lg btn-light fas fa-hand-paper text-warning"
            data-notify-class="fas fa-hand-paper text-warning"></button>
        <button id="good-button" class="btn btn-light fas fa-thumbs-up text-success"
            data-notify-class="fas fa-thumbs-up text-success"></button>
        <button id="nogood-button" class="btn btn-light fas fa-thumbs-down text-danger"
            data-notify-class="fas fa-thumbs-down text-danger"></button>
        <button id="applause-button" class="btn btn-light fas fa-sign-language text-info"
            data-notify-class="fas fa-sign-language text-info"></button>
    </div>

    <div id="card-menu-dialog" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">付箋の操作</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <label for="card-menu-color-selection">色</label>
                            <select id="card-menu-color-selection">
                                <option value="" selected>選択...</option>
                                <option value="red" class="color-red">赤</option>
                                <option value="blue" class="color-blue">青</option>
                                <option value="green" class="color-green">緑</option>
                                <option value="yellow" class="color-yellow">黄色</option>
                                <option value="white" class="color-white">白</option>
                                <option value="transparent">透明</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div id="yesno-dialog" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">確認</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button class="no btn btn-secondary" data-dismiss="modal">いいえ</button>
                    <button class="yes btn btn-primary">はい</button>
                </div>
            </div>
        </div>
    </div>

    <div id="input-dialog" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                </div>
                <div class="modal-body">
                    <form>
                        <div>
                            <input type="text" class="form-control" id="input-box" name="inputBox">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="yes btn btn-primary">はい</button>
                </div>
            </div>
        </div>
    </div>

    <div id="create-url-dialog" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">URLを生成</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="card-template" class="d-none card sticky-note canvas-item" data-toggle="tooltip" data-placement="top">
        <div class="sticky-note-header">
        </div>
        <div class="sticky-note-body">
            <textarea></textarea>
            <div class="textarea-cover"></div>
        </div>
        <div class="sticky-note-footer container-fluid">
            <div class="row">
                <div class="col-sm-4"></div>
                <div class="col-sm-4"></div>
                <div class="col-sm-4"></div>
            </div>
        </div>
        <div class="menuset">
            <div class="edit icon fas fa-edit" title="編集"></div>
            <div class="menu icon fas fa-bars" title="設定"></div>
            <div class="tofront icon fas fa-chevron-up" title="最前面に移動"></div>
            <div class="toback icon fas fa-chevron-down" title="最背面に移動"></div>
            <div class="delete icon fas fa-trash-alt" title="削除"></div>
        </div>
    </div>

    <div id="markdown-template" class="d-none markdown card canvas-item">
        <div class="markdown-header"></div>
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active md-view" data-toggle="tab" href="" role="tab" aria-controls=""
                    aria-selected="true">表示</a>
            </li>
            <li class="nav-item">
                <a class="nav-link md-editor" data-toggle="tab" href="" role="tab" aria-controls=""
                    aria-selected="false">編集</a>
            </li>
            <li class="nav-item spacer"></li>
        </ul>
        <div class="tab-content">
            <div class="md-view tab-pane show active"></div>
            <div class="md-editor tab-pane">
                <textarea class="editing">## デフォルトサンプル

参考: [Marked](https://marked.js.org/), [Mermaidjs](https://mermaidjs.github.io/)。

### アーキテクチャ

|サービス|用途|
|-|-|
|GitHub Pages|Web サーバ|
|Heroku|WebSocket サーバ|

```
graph TB
ブラウザ --> Heroku
Heroku --> ブラウザ
ブラウザ --> GitHub_Pages
```
</textarea>
            </div>
        </div>
        <div class="menuset">
            <div class="tofront icon fas fa-chevron-up" title="最前面に移動"></div>
            <div class="toback icon fas fa-chevron-down" title="最背面に移動"></div>
            <div class="delete icon fas fa-trash-alt" title="削除"></div>
        </div>
    </div>

    <div id="common-item-template" class="d-none">
        <div class="menuset">
            <div class="tofront icon fas fa-chevron-up" title="最前面に移動"></div>
            <div class="toback icon fas fa-chevron-down" title="最背面に移動"></div>
            <div class="delete icon fas fa-trash-alt" title="削除"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous">
        </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous">
        </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cuid/1.3.8/browser-cuid.min.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mouse0270-bootstrap-notify/3.1.7/bootstrap-notify.min.js"
        integrity="sha256-LlN0a0J3hMkDLO1mhcMwy+GIMbIRV7kvKHx4oCxNoxI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"
        integrity="sha256-AAhU14J4Gv8bFupUUcHaPQfvrdNauRHMt+S4UVcaJb0=" crossorigin="anonymous"></script>
    <script>
        const config = {
            socketioServer: "https://simple-websocket-server.herokuapp.com",
            socketioScript: "/socket.io/socket.io.js",
            skyWayApiKey: '6a3a377a-d7fb-468c-86b4-a411d69110d8',
            skyWayScript: "https://cdn.webrtc.ecl.ntt.com/skyway-latest.js",
        };
        let scaleStep = 0.1;
        var currentScale = 1.0;
        var selectedCardId = null;

        var click = {
            x: 0,
            y: 0
        };

        // for scalable select..
        let oldOuterWidth = $.fn.outerWidth;
        let oldOuterHeight = $.fn.outerHeight;

        $(function () {
            setupShortcutKeys();
            $('[data-toggle="tooltip"]').tooltip();
            $("#add-narrative-arc-button").on("click", addNarativeArc);
            $("#add-button").on("click", add);
            $("#undo-button").on("click", undo);
            $("#redo-button").on("click", redo);
            $("#send-to-front-button").on("click", sendToFront);
            $("#send-to-back-button").on("click", sendToBack);
            $("#zoom-in-button").on("click", zoomIn);
            $("#zoom-out-button").on("click", zoomOut);
            $("#zoom-fit-button").on("click", zoomFitWidth);
            $("#zoom-reset-button").on("click", zoomReset);
            $("#set-canvas-size-button").on("click", setCanvasSize);
            $("#delete-item-button").on("click", deleteItem);
            $("#add-horizontal-line-button").on("click", addHorizonalLine);
            $("#add-vertical-line-button").on("click", addVerticalLine);
            $("#add-image-button").on("click", (e) => {
                $("#image-file-selection").click();
            });
            $("#add-markdown-button").on("click", addMarkdown);
            $("#export-button").on("click", exportData);
            $("#import-button").on("click", importData);
            $("#create-url-button").on("click", createUrl);
            $(document).on("paste", addImageFromClipboard);
            $("#create-room-button").on("click", createRoom);
            $("#push-button").on("click", push);
            $("#reaction-buttons button").on("click", e => notify($(e.target).data("notify-class")));
            $("#canvas").on("mousemove", syncMousePosition)
            $("#clear-pointers-button").on("click", clearPointers);
            $(document).on("click", ".menuset .tofront", function (e) {
                $(e.target).parent(".canvas-item").addClass("ui-select");
                sendToFront();
            });
            $(document).on("click", ".menuset .toback", function (e) {
                $(e.target).parent(".canvas-item").addClass("ui-select");
                sendToBack();
            });
            $(document).on("click", ".menuset .delete", function (e) {
                $(e.target).parent(".canvas-item").addClass("ui-select");
                deleteItem();
            });
            toSelectable($("#canvas"));

            // card menu dialog.
            $("#card-menu-dialog").on("hide.bs.modal", () => {
                selectedCardId = null;
            });
            $("#card-menu-dialog").on("hidden.bs.modal", () => {
                $("#card-menu-color-selection").val("");
            });
            $("#card-menu-color-selection").on("change", (e) => {
                changeColor(getEditTargetCards(), $(e.target).val());
                $("#card-menu-dialog").modal("hide");
            });

            // add image dialog
            $("#image-file-selection").on("change", loadImageFromLocal);

            // initialize width & height.
            $("#canvas-width").val($("#canvas").width());
            $("#canvas-height").val($("#canvas").height());

            // initialize margin of main.
            adjustMainMarginTop();
            $(window).on("resize", adjustMainMarginTop);
            $(window).on("resize", function () { applyScale(currentScale); });

            // setup confrim
            $(window).on('beforeunload', function (event) {
                const message = `この画面から離れても良いですか?`;
                event.returnValue = message;
                return message;
            });

            setupMarkdownRenderWithMermaid();

            initRoom();
            loadDataFromParameter();

            // accessible to item menu
            $("#canvas").on("click", ".canvas-item", function() {
                toFrontMostItems($(this));
            });
        });

        function addNarativeArc() {
            const resize = (elm, width, height) => {
                const oldWidth = $(elm).width();
                const oldHeight = $(elm).height();
                $(elm).width(width);
                $(elm).height(height);
                AppEvent.ResizeItem.publish($(elm), oldWidth, oldHeight);
            };
            const move = (elm, moveLeft, moveTop) => {
                const ids = [$(elm).attr("id")];
                const oldLeft = $(elm).offset().left;
                const oldTop = $(elm).offset().top;
                const oldPositions = [{ left: oldLeft, top: oldTop }];
                $(elm).offset({ left: oldLeft + moveLeft, top: oldTop + moveTop });
                AppEvent.MoveItems.publish(ids, oldPositions, moveLeft, moveTop);
            };
            const addCard = (text) => {
                const card = add();
                card.width(150);
                card.height(25);
                changeColor(card, "transparent");
                $(card).find("textarea").text(text + " ...").change();
                adjustFontSize($(card).find("textarea"));
                return card;
            };
            const arc = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/narrative-arc.svg");
            resize(arc, 1000, 300);
            move(arc, 0, 70);

            const incrementalX = 125;
            let offsetX = 0;
            const situationExplanation = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/RosenfeldMedia/situation_explanation.png");
            resize(situationExplanation, 70, 70);
            move(situationExplanation, offsetX, 310);
            move(addCard("状況説明"), offsetX, 270);
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);

            offsetX += incrementalX;
            const trigger = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/RosenfeldMedia/trigger.png");
            resize(trigger, 80, 60);
            move(trigger, offsetX, 280);
            move(addCard("きっかけ"), offsetX, 240);
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);

            offsetX += incrementalX;
            const step = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/RosenfeldMedia/step.png");
            resize(step, 50, 50);
            move(step, offsetX, 250);
            move(addCard("いくつかの手順"), offsetX, 220);
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);
            offsetX += incrementalX;
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);

            offsetX += incrementalX;
            const crisis = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/RosenfeldMedia/crisis.png");
            resize(crisis, 50, 50);
            move(crisis, offsetX, 130);
            move(addCard("危機"), offsetX, 100);
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);

            offsetX += incrementalX;
            const climax = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/RosenfeldMedia/climax.png");
            resize(climax, 80, 80);
            move(climax, offsetX, 40);
            move(addCard("クライマックス"), offsetX, 10);
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);

            offsetX += incrementalX;
            const andThen = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/RosenfeldMedia/and_then.png");
            resize(andThen, 50, 50);
            move(andThen, offsetX, 200);
            move(addCard("それから"), offsetX, 170);
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);

            offsetX += incrementalX;
            const ending = addImage("https://redfe.github.io/simple-sticky-notes-assets/storymapping/RosenfeldMedia/ending.png");
            resize(ending, 55, 50);
            move(ending, offsetX, 330);
            move(addCard("エンディング"), offsetX, 300);
            move(add(), offsetX, 400);
            move(add(), offsetX, 470);
            move(add(), offsetX, 540);

        }

        function add() {

            let color = "yellow";
            let cardId = cuid();
            let card = $("#card-template").clone();
            let cardMenuButton = $(card).find(".menu.icon");
            let cardEditButton = $(card).find(".edit.icon");
            let cardTextarea = $(card).find("textarea");

            cardMenuButton.on("click", (e) => {
                selectedCardId = $(e.target).parents(".sticky-note").attr("id");
                $("#card-menu-dialog").modal();
            });

            cardEditButton.on("click", (e) => {
                card.find(".textarea-cover").hide();
                cardTextarea.addClass("editing");
                const len = cardTextarea.val().length;
                cardTextarea[0].selectionStart = len;
                cardTextarea[0].selectionEnd = len;
                cardTextarea.focus();
            });

            $(cardTextarea).on("change", (e) => {
                const tooltipData = $(card).data()["bs.tooltip"];
                const oldText = tooltipData ? tooltipData.config.title : "";
                AppEvent.ChangeStickyNoteText.publish($(card), oldText);
                updateTooltip(card, $(e.target).val());
            });

            $(cardTextarea).on("keyup", (e) => {
                // escape key.
                if (e.keyCode == 27) {
                    cardTextarea.blur();
                }
            });

            $(cardTextarea).on("focus", (e) => {
                // auto expand.
                if (1 <= currentScale) {
                    return;
                }
                $(card)
                    .css("transform-origin", "left top")
                    .css("transform", "scale(" + (1 / currentScale) + ")");
                $(card).tooltip("dispose");
                $(card).resizable("disable");
            });

            $(cardTextarea).on("blur", (e) => {
                // return expand.
                setTimeout(() => {
                    $(card)
                        .css("transform-origin", "none")
                        .css("transform", "none");
                    $(card).resizable("enable");
                }, 500); //for car menu button.
                cardTextarea.removeClass("editing");
                card.find(".textarea-cover").show();
            });

            $(cardTextarea).on("keydown keyup", function () {
                adjustFontSize(cardTextarea);
            });

            card.attr("id", cardId);
            card.removeClass("d-none");
            card.addClass("card");
            card.addClass("color-" + color);

            initializePosition(card);

            // add from this card on double clik .
            $(card).on("dblclick", (e) => {
                addStickyNoteFrom(card);
            });
            $(cardTextarea).on("dblclick", (e) => {
                e.stopPropagation();
                return false;
            });


            // resizable
            $(card).resizable({
                aspectRatio: false,
                autoHide: true,
                resize: function (event, ui) {
                    let height = ui.originalSize.height + ((ui.size.height - ui.originalSize.height) /
                        currentScale);
                    $(card).height(height);
                    let width = ui.originalSize.width + ((ui.size.width - ui.originalSize.width) /
                        currentScale);
                    $(card).width(width);
                },
                stop: function (event, ui) {
                    AppEvent.ResizeItem.publish($(event.target), ui.originalSize.width, ui.originalSize
                        .height);
                    adjustFontSize(cardTextarea);
                }
            });

            $("#canvas").append(card);
            toFrontMostItems(card);

            toDraggable(card);

            AppEvent.AddItem.publish(card);

            return card;
        }

        function addHorizonalLine() {
            addLine(false);
        }

        function addVerticalLine() {
            addLine(true);
        }

        function addLine(isVertical) {
            let lineId = cuid();
            var line = $("#common-item-template").clone();
            line.removeClass("d-none");
            line.addClass("line canvas-item");
            line.addClass(isVertical ? "vertical-line" : "horizontal-line");
            line.attr("id", lineId);
            initializePosition(line);
            let handles = isVertical ? "s" : "e";
            line.resizable({
                handles: handles,
                autoHide: true,
                resize: function (event, ui) {
                    if (isVertical) {
                        let length = ui.originalSize.height + ((ui.size.height - ui.originalSize.height) /
                            currentScale);
                        $(line).height(length);
                    } else {
                        let length = ui.originalSize.width + ((ui.size.width - ui.originalSize.width) /
                            currentScale);
                        $(line).width(length);
                    }
                },
                stop: function (event, ui) {
                    AppEvent.ResizeItem.publish($(event.target), ui.originalSize.width, ui.originalSize
                        .height);
                }
            });

            // add from this line on double clik .
            $(line).on("dblclick", (e) => {
                addLineFrom(line);
            });

            $("#canvas").append(line);
            toFrontMostItems(line);
            toDraggable(line);

            AppEvent.AddItem.publish(line);

            return line;
        }

        function addImage(sourceUrl) {
            const imageId = cuid();
            const image = $("#common-item-template").clone();
            $(image).removeClass("d-none");
            $(image).attr("id", imageId);
            $(image).addClass("image canvas-item")
            $(image).append($("<img>"));
            initializePosition(image);
            $(image).find("img").attr("src", sourceUrl);

            $(image).resizable({
                aspectRatio: false,
                autoHide: true,
                resize: function (event, ui) {
                    let height = ui.originalSize.height + ((ui.size.height - ui.originalSize.height) /
                        currentScale);
                    $(image).height(height);
                    let width = ui.originalSize.width + ((ui.size.width - ui.originalSize.width) /
                        currentScale);
                    $(image).width(width);
                },
                stop: function (event, ui) {
                    AppEvent.ResizeItem.publish($(event.target), ui.originalSize.width, ui.originalSize
                        .height);
                }
            });
            $(image).on("dblclick", (e) => {
                isRecordEvents = false;
                let added;
                try {
                    added = addImage($(image).find("img").attr("src"));
                    setPositionAsCopied(image, added);
                    added.width($(image).width());
                    added.height($(image).height());
                } finally {
                    isRecordEvents = true;
                }
                AppEvent.AddItem.publish(added);
            });
            $(image).width(200);
            $(image).height(200);
            $("#canvas").append(image);
            toFrontMostItems(image);
            toDraggable(image);

            AppEvent.AddItem.publish(image);

            return image;
        }

        function addImageFromClipboard(event) {
            const active = document.activeElement;
            if (active["type"]) {
                const focusType = active.type.toLowerCase();
                if (focusType == "text" || focusType == "textarea") {
                    return;
                }
            }
            var items = event.originalEvent.clipboardData.items;
            for (var i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf("image") != -1) {
                    const file = item.getAsFile();
                    readFileAsBase64Url(file, (dataUrl) => {
                        addImage(dataUrl);
                    });
                    return;
                } else if (item.type == "text/plain") {
                    item.getAsString(v => {
                        if (v.toLowerCase().startsWith("http")) {
                            addImage(v);
                        }
                    });
                    return;
                }
            }
        }

        function addMarkdown() {
            const itemId = cuid();
            const markdown = $("#markdown-template").clone();
            const viewButton = $(markdown).find("a.md-view");
            const editButton = $(markdown).find("a.md-editor");
            const viewArea = $(markdown).find("div.md-view");
            const editArea = $(markdown).find("div.md-editor");

            // setup bootstrap navtab.
            viewArea.attr("id", cuid());
            viewButton.attr("href", "#" + viewArea.attr("id"));
            viewButton.attr("aria-controls", viewArea.attr("id"));
            editArea.attr("id", cuid());
            editButton.attr("href", "#" + editArea.attr("id"));
            editButton.attr("aria-controls", editArea.attr("id"));

            $(editArea).find("textarea").on("change", () => {
                const oldText = getMarkdownTextData($(markdown));
                setMarkdownTextData($(markdown), $(markdown).find("textarea").val());
                AppEvent.ChangeMarkdownText.publish($(markdown), oldText);
            });

            $(viewButton).on("click", () => {
                $(viewArea).html("");
                setTimeout(() => {
                    $(markdown).find("div.tab-content").css("overflow-y", "scroll");
                    renderMarkdown($(editArea).find("textarea").val(), $(viewArea));
                }, 100);
            });
            $(editButton).on("click", () => {
                $(markdown).find("div.tab-content").css("overflow-y", "hidden");
                setTimeout(() => {
                    const textarea = $(editArea).find("textarea");
                    textarea[0].selectionStart = 0;
                    textarea[0].selectionEnd = 0;
                    textarea.focus();
                }, 300);
            });

            markdown.attr("id", itemId);
            markdown.removeClass("d-none");

            initializePosition(markdown);

            // add from this markdown on double clik .
            $(markdown).find(".markdown-header,.spacer").on("dblclick", (e) => {
                addMarkdownFrom(markdown);
            });

            // resizable
            $(markdown).resizable({
                aspectRatio: false,
                autoHide: true,
                resize: function (event, ui) {
                    let height = ui.originalSize.height + ((ui.size.height - ui.originalSize.height) /
                        currentScale);
                    $(markdown).height(height);
                    let width = ui.originalSize.width + ((ui.size.width - ui.originalSize.width) /
                        currentScale);
                    $(markdown).width(width);
                },
                stop: function (event, ui) {
                    AppEvent.ResizeItem.publish($(markdown), ui.originalSize.width, ui.originalSize
                        .height);
                }
            });

            $("#canvas").append(markdown);
            toFrontMostItems(markdown);
            toDraggable(markdown);

            // view
            viewButton.trigger("click");

            AppEvent.AddItem.publish(markdown);

            return markdown;
        }

        const mermaidKeyKeywords = [
            "sequenceDiagram",
            "graph",
            "gantt",
            "classDiagram",
            "gitGraph",
            "stateDiagram",
            "pie"
        ];

        function setupMarkdownRenderWithMermaid() {
            var renderer = new marked.Renderer();
            renderer.code = function (code, language) {
                if (matchMermaid(code)) {
                    return '<div class="mermaid">' + code + '</div>';
                } else {
                    return '<pre><code>' + sanitize(code) + '</code></pre>';
                }
            };
            marked.setOptions({
                renderer: renderer,
                sanitize: true
            });
        }

        function matchMermaid(code) {
            for (let i = 0; i < mermaidKeyKeywords.length; i++) {
                const regexp = new RegExp('^' + mermaidKeyKeywords[i], 'g')
                if (code.match(regexp)) {
                    return true;
                }
            }
            return false;
        }

        function sanitize(s) {
            // TODO do properly.
            if (s) {
                return s.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }
            return s;
        }

        function renderMarkdown(text, view) {
            $(view).html("<div></div>");
            $(view).find("div").html(marked(text));
            $(view).find("a").each((i, e) => {
                const href = $(e).attr("href");
                if (href && href.startsWith("http")) {
                    $(e).attr("target", "_blank");
                }
            });
            try {
                mermaid.init(undefined, $(view).find(".mermaid"));
            } catch (error) { }
        }

        function setMarkdownTextData(markdown, text) {
            $(markdown).data("text", text);
        }

        function getMarkdownTextData(markdown) {
            const val = $(markdown).data("text");
            return !val ? "" : val;
        }

        function initializePosition(item) {
            let scrollX = window.scrollX / currentScale;
            let scrollY = window.scrollY / currentScale;
            item.css("top", scrollY + 30 + "px");
            item.css("left", scrollX + 30 + "px");
        }

        function sendToFront() {
            const targets = $("#canvas .ui-selected").sort(compareByZIndex);
            if (!targets || targets.length == 0) {
                return;
            }
            const targetIds = $.makeArray(targets.map((i, v) => $(v).attr("id")));
            const zIndexes = $.makeArray(targets.map((i, v) => parseInt($(v).css("z-index"))));
            toFrontMostItems(targets);
            AppEvent.SendToFront.publish(targetIds, zIndexes);
        }

        function toFrontMostItems(targetItems) {
            const targets = $(targetItems).sort(compareByZIndex);
            if (!targets || targets.length == 0) {
                return;
            }
            const canvasItems = $("#canvas .canvas-item").not(targets).sort(compareByZIndex);
            const results = $.merge(canvasItems, targets);
            results.each((i, v) => {
                $(v).css("z-index", i);
            });
        }

        function sendToBack() {
            const targets = $("#canvas .ui-selected").sort(compareByZIndex);
            if (!targets || targets.length == 0) {
                return;
            }
            const targetIds = $.makeArray(targets.map((i, v) => $(v).attr("id")));
            const zIndexes = $.makeArray(targets.map((i, v) => parseInt($(v).css("z-index"))));
            toBackMostItems(targets);
            AppEvent.SendToBack.publish(targetIds, zIndexes);

        }

        function toBackMostItems(targetItems) {
            const targets = $(targetItems).sort(compareByZIndex);
            const canvasItems = $("#canvas .canvas-item").not(targets).sort(compareByZIndex);
            const results = $.merge(targets, canvasItems);
            results.each((i, v) => {
                $(v).css("z-index", i);
            });
        }

        function setPositionAsCopied(source, target) {
            let sourceLeft = parseFloat($(source).css("left"));
            let sourceTop = parseFloat($(source).css("top"));
            target.css("left", sourceLeft + 5 + "px");
            target.css("top", sourceTop + 5 + "px");
        }

        function addStickyNoteFrom(from) {
            let added;
            isRecordEvents = false;
            try {
                let target = $(from).attr("id") ? $(from) : $(from).parents(".sticky-note");
                added = add();
                let colorClass = findFirstClass(target, (className) => className.startsWith("color-"));
                isRecordEvents = false;
                changeColor(added, colorClass ? colorClass.substring(6) : "color-yellow");
                setPositionAsCopied(target, added);
                added.width($(from).width());
                added.height($(from).height());
                adjustFontSize(added.find("textarea"));
            } finally {
                isRecordEvents = true;
            }
            AppEvent.AddItem.publish(added);
        }

        function addLineFrom(from) {
            var added;
            isRecordEvents = false;
            try {
                let target = $(from).attr("id") ? $(from) : $(from).parents(".line");
                let isVertical = $(target).hasClass("vertical-line");
                added = addLine(isVertical);
                setPositionAsCopied(target, added);
                if (isVertical) {
                    added.height($(target).height());
                } else {
                    added.width($(target).width());
                }
            } finally {
                isRecordEvents = true;
            }
            AppEvent.AddItem.publish(added);
        }

        function addMarkdownFrom(from) {
            let added;
            isRecordEvents = false;
            try {
                let target = $(from).attr("id") ? $(from) : $(from).parents(".markdown");
                added = addMarkdown();
                setPositionAsCopied(target, added);
                added.width($(from).width());
                added.height($(from).height());
            } finally {
                isRecordEvents = true;
            }
            AppEvent.AddItem.publish(added);
        }

        function updateTooltip(target, text) {
            $(target).tooltip("dispose");
            $(target).tooltip({
                title: text
            });
        }

        function removeColorClass(target) {
            target.removeClass(findClasses(target, (val) => val.startsWith("color-")).join(" "));
        }

        function findFirstClass(target, filterFunction) {
            let filtered = findClasses(target, filterFunction);
            let result = filtered.length == 0 ? null : filtered[0];
            return result;
        }

        function findClasses(target, filterFunction) {
            return $(target).attr("class").split(" ").filter((val) => {
                return filterFunction(val);
            });
        }

        function toDraggable(item) {
            const getMoveTargets = function () {
                if (!$(item).hasClass("ui-selected")) {
                    return $(item);
                } else {
                    return $(".ui-selected");
                }
            };
            $(item).css("position", "absolute");
            // In the case of zoom-in / zoom-out, since the position of the drag shifts, it is necessary to adjust it.
            // see https://stackoverflow.com/questions/13882070/jquery-draggable-and-webkit-transform-scale
            $(item).draggable({
                stack: false,
                start: function (event) {
                    click.x = event.clientX;
                    click.y = event.clientY;
                    $(getMoveTargets()).each((i, target) => {
                        $(target).attr("startX", parseInt($(target).css("left")));
                        $(target).attr("startY", parseInt($(target).css("top")));
                    });
                    // dispose tooltip.
                    if ($(event.target).hasClass("sticky-note")) {
                        $(event.target).tooltip("dispose");
                    }
                },
                drag: function (event, ui) {
                    // This is the parameter for scale()
                    var zoom = currentScale;

                    var original = ui.originalPosition;

                    // jQuery will simply use the same object we alter here
                    ui.position = {
                        left: (event.clientX - click.x + original.left) / zoom,
                        top: (event.clientY - click.y + original.top) / zoom
                    };

                    let moveX = original.left / zoom - ui.position.left;
                    let moveY = original.top / zoom - ui.position.top;

                    // move selected item.
                    $(getMoveTargets()).each((i, target) => {
                        $(target).css("left", ($(target).attr("startX") - moveX) + "px");
                        $(target).css("top", ($(target).attr("startY") - moveY) + "px");
                    });
                },
                stop: function (event, ui) {
                    // enable tooltip.
                    if ($(event.target).hasClass("sticky-note")) {
                        $(event.target).tooltip({
                            title: $(event.target).find("textarea").val()
                        });
                    }
                    const ids = []
                    const oldPositions = [];
                    $(getMoveTargets()).each(function (i, elem) {
                        ids.push($(elem).attr("id"));
                        oldPositions.push({
                            left: $(elem).attr("startX"),
                            top: $(elem).attr("startY")
                        });
                    });

                    const moveLeft = parseInt($(event.target).css("left")) - $(event.target).attr(
                        "startX");
                    const moveTop = parseInt($(event.target).css("top")) - $(event.target).attr(
                        "startY");

                    AppEvent.MoveItems.publish(ids, oldPositions, moveLeft, moveTop);

                }
            });
        }

        function toSelectable(canvas) {
            $(canvas).selectable({
                filter: ".canvas-item",
                start: (e, ui) => {
                    $(".sticky-note textarea").blur();
                }
            });
            $(canvas).on("mousedown", ".canvas-item", function (e) {
                const target = $(e.target).hasClass("canvas-item") ? $(e.target) : $(e.target).parents(
                    ".canvas-item");
                const withCtrl = navigator.platform.indexOf("Mac") >= 0 ?
                    e.metaKey : e.ctrlKey;
                if ($(target).hasClass("ui-selected")) {
                    if (withCtrl) {
                        $(target).removeClass("ui-selected");
                    }
                } else {
                    if (!withCtrl) {
                        $(".ui-selected").removeClass("ui-selected");
                    }
                    $(target).addClass("ui-selected");
                }
            });
            // for scaleable select.
            $.fn.outerWidth = function () {
                var w = oldOuterWidth.apply($(this));
                if ($(this).hasClass("canvas-item") &&
                    $(this).hasClass("ui-selectee")) {
                    return w * currentScale;
                } else {
                    return w;
                }
            };
            $.fn.outerHeight = function () {
                var h = oldOuterHeight.apply($(this));
                if ($(this).hasClass("canvas-item") &&
                    $(this).hasClass("ui-selectee")) {
                    return h * currentScale;
                } else {
                    return h;
                }
            };
        }

        function adjustFontSize(textarea) {
            const minFontSize = 10;
            const maxFontSize = 150;

            const toSmall = function () {
                const fontSize = parseFloat($(textarea).css("font-size"));
                if (fontSize <= minFontSize) {
                    return;
                }
                const minScrollHeight = Math.round($(textarea).height());
                if (minScrollHeight >= $(textarea)[0].scrollHeight) {
                    return;
                }
                $(textarea).css("font-size", (fontSize - 1) + "px");
                const appliedFontSize = parseFloat($(textarea).css("font-size"));
                if (fontSize == appliedFontSize) {
                    return;
                }
                toSmall();
            };

            const toBig = function () {
                const fontSize = parseFloat($(textarea).css("font-size"));
                if (fontSize >= maxFontSize) {
                    return;
                }
                $(textarea).css("font-size", (fontSize + 1) + "px");
                const appliedFontSize = parseFloat($(textarea).css("font-size"));
                if (fontSize == appliedFontSize) {
                    return;
                }
                adjustFontSize(textarea);
            };

            const minScrollHeight = Math.round($(textarea).height());
            const currentScrollHeight = $(textarea)[0].scrollHeight;
            if (minScrollHeight < currentScrollHeight) {
                toSmall();
            } else {
                toBig();
            }
        }

        function zoomIn() {
            applyScale(currentScale + (currentScale * scaleStep));
        }

        function zoomOut() {
            applyScale(currentScale - (currentScale * scaleStep));
        }

        function zoomFitWidth() {
            applyScale($(window).width() / $("#canvas").width(), true);
            scrollTo(0, 0);
        }

        function zoomReset() {
            applyScale(1);
        }

        function applyScale(newScale, disableAnchor) {
            // do nothing while resizing.
            if ($(".ui-resizable-resizing").length > 0) {
                return;
            }
            const resize = () => {
                $("#canvas")
                    .css("transform", "scale(" + newScale + ")")
                    .css("transform-origin", "left top");
            };
            if (disableAnchor || $(".ui-selected").length == 0) {
                var mostLeft = $(window).scrollLeft() / currentScale;
                var mostRight = mostLeft + ($(window).width() / currentScale);
                var mostTop = ($(window).scrollTop() / currentScale) - ($("#menu").height() / currentScale);
                var mostBottom = mostTop + ($(window).height() / currentScale);
                resize();
                $(window).scrollLeft(mostLeft * newScale - ($(window).width() / 2) + ((mostRight - mostLeft) *
                    newScale / 2));
                $(window).scrollTop($("#menu").height() + mostTop * newScale - ($(window).height() / 2) + ((
                    mostBottom - mostTop) * newScale / 2));
            } else {
                let selecteds = $(".canvas-item.ui-selected");
                var mostLeft = Math.min.apply(null, $.map(selecteds, x => parseInt($(x).css("left"))));
                var mostRight = Math.max.apply(null, $.map(selecteds, x => parseInt($(x).css("left")) + $(x).width()));
                var mostTop = Math.min.apply(null, $.map(selecteds, x => parseInt($(x).css("top"))));
                var mostBottom = Math.max.apply(null, $.map(selecteds, x => parseInt($(x).css("top")) + $(x).height()));
                resize();
                $(window).scrollLeft(mostLeft * newScale - ($(window).width() / 2) + ((mostRight - mostLeft) *
                    newScale / 2));
                $(window).scrollTop($("#menu").height() + mostTop * newScale - ($(window).height() / 2) + ((
                    mostBottom - mostTop) * newScale / 2));
            }
            currentScale = newScale;
        }

        function setCanvasSize() {
            let w = $("#canvas-width").val();
            let h = $("#canvas-height").val();
            $("#canvas").width(w).height(h);
        }

        function changeColor(targets, color) {
            const oldColors = [];
            $(targets).each((i, target) => {
                oldColors.push(findFirstClass(target, (className) => className.startsWith("color-")));
            });
            let colors = $("#card-menu-color-selection").find("option").each((i, v) => {
                targets.removeClass("color-" + $(v).val());
            });
            const colorClass = "color-" + color;
            targets.addClass(colorClass);
            AppEvent.ChangeStickyNotesColor.publish(targets, oldColors, colorClass);
        }

        function deleteItem() {
            let targets = $(".ui-selected");

            // clone() is not copy width.
            AppEvent.DeleteItems.publish(targets);

            $(targets).hide({
                done: (target) => {
                    $(target.elem).remove();
                }
            });
        }

        function getEditTargetCards() {
            if ($("#" + selectedCardId + ".ui-selected.sticky-note").length == 1) {
                return $(".ui-selected.sticky-note");
            } else {
                return $("#" + selectedCardId);
            }
        }

        function adjustMainMarginTop() {
            $("#canvas").css("margin-top", $("#menu").innerHeight());
            $("#reaction-buttons").css("margin-top", $("#menu").innerHeight());
        }

        function loadImageFromLocal(event) {
            if (event.target.files.length == 0) {
                return;
            }
            const file = event.target.files[0];
            if (!file.type.startsWith("image")) {
                return;
            }

            readFileAsBase64Url(file, (dataUrl) => {
                addImage(dataUrl);
                event.target.value = null;
                $("#add-image-dialog").modal("hide");
            });
        }

        function readFileAsBase64Url(file, callback) {
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                var dataUrl = reader.result;
                callback(dataUrl);
            }
        }

        function exportData() {
            const json = JSON.stringify(createExportData());
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([json], {
                type: 'text/json'
            }));
            a.download = "simple-sticky-note_" + getCurrentDatetimeString() + ".json";
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function createExportData() {
            const obj = {
                canvas: {
                    width: $("#canvas-width").val(),
                    height: $("#canvas-height").val()
                },
                items: []
            };
            $(".canvas-item:visible").each(function (i, elem) {
                obj.items[i] = convertToDataForExport(elem);
            });
            return obj;
        }

        function importData() {
            const input = document.createElement('input')
            input.type = "file";
            input.addEventListener("change", function (event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.readAsText(file);
                reader.onloadend = function () {
                    var json = reader.result;
                    importDataFromJson(json);
                };
            });
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        function createUrl() {
            const json = JSON.stringify(createExportData());
            const url = location.protocol + "//"
                + location.hostname
                + (location.port == 80 ? "" : ":" + location.port)
                + location.pathname
                + "?data=" + enc64(json);
            $("#create-url-dialog .modal-body textarea").val(url);
            $("#create-url-dialog").modal();
        }

        function loadDataFromParameter() {
            if (!location.search) {
                return;
            }
            const index = location.search.indexOf("?data=");
            if (index < 0) {
                return;
            }
            const param = location.search.substring(index + "?data=".length);
            importDataFromJson(dec64(param));
            history.replaceState("", "", "index.html");
        }

        function enc64(str) {
            return Base64.encode(str);
        }

        function dec64(str) {
            return Base64.decode(str);
        }

        var Base64 = {
            encode: function (str) {
                return btoa(unescape(encodeURIComponent(str)));
            },
            decode: function (str) {
                return decodeURIComponent(escape(atob(str)));
            }
        }

        function getCurrentDatetimeString() {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours();
            const minute = date.getMinutes();
            const second = date.getSeconds();
            return zeroPadding(year, 4) +
                zeroPadding(month, 2) +
                zeroPadding(day, 2) +
                zeroPadding(hour, 2) +
                zeroPadding(minute, 2) +
                zeroPadding(second, 2)
        }

        function zeroPadding(num, length) {
            const str = num.toString();
            const addLen = str.length < length ? length - str.length : 0;
            const sliceLen = str.length < length ? length : str.length;
            var preZeros = "";
            for (var i = 0; i < addLen; i++) {
                preZeros = preZeros + "0";
            }
            return (preZeros + num).slice(-sliceLen);
        }

        function convertToDataForExport(elem) {
            if ($(elem).hasClass("sticky-note")) {
                return convertToStikyNoteDataForExport(elem);
            } else if ($(elem).hasClass("vertical-line")) {
                return convertToVerticalLineDataForExport(elem);
            } else if ($(elem).hasClass("horizontal-line")) {
                return convertToHorizontalLineDataForExport(elem);
            } else if ($(elem).hasClass("image")) {
                return convertToImageDataForExport(elem);
            } else if ($(elem).hasClass("markdown")) {
                return convertToMarkdownDataForExport(elem);
            }
            return null;
        }

        function convertToStikyNoteDataForExport(elem) {
            $e = $(elem);
            const colorClass = findFirstClass($e, (className) => className.startsWith("color-"));
            return {
                type: "sticky-note",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                width: $e.width(),
                height: $e.height(),
                zIndex: $e.css("z-index"),
                text: $e.find("textarea").val(),
                color: colorClass
            };
        }

        function drawStickyNoteFromData(data) {
            var item = add();
            $(item)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .width(data.width)
                .height(data.height)
                .css("z-index", data.zIndex)
                .removeClass("color-yellow")
                .addClass(data.color)
                .find("textarea").val(data.text);

            $(item).tooltip({
                title: data.text
            });
            $(item).find("textarea").trigger("keydown");
        }

        function convertToVerticalLineDataForExport(elem) {
            $e = $(elem);
            return {
                type: "vertical-line",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                zIndex: $e.css("z-index"),
                length: $e.height()
            };
        }

        function drawVerticalLineFromData(data) {
            var line = addLine(true);
            $(line)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .css("z-index", data.zIndex)
                .height(data.length);
        }

        function convertToHorizontalLineDataForExport(elem) {
            $e = $(elem);
            return {
                type: "horizontal-line",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                zIndex: $e.css("z-index"),
                length: $e.width()
            };
        }

        function drawHorizontalLineFromData(data) {
            var line = addLine(false);
            $(line)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .css("z-index", data.zIndex)
                .width(data.length);
        }

        function convertToImageDataForExport(elem) {
            $e = $(elem);
            return {
                type: "image",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                width: $e.width(),
                height: $e.height(),
                zIndex: $e.css("z-index"),
                src: $e.find("img").attr("src")
            };
        }

        function drawImageFromData(data) {
            var line = addImage(data.src);
            $(line)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .width(data.width)
                .height(data.height)
                .css("z-index", data.zIndex);
        }

        function convertToMarkdownDataForExport(elem) {
            $e = $(elem);
            return {
                type: "markdown",
                id: $e.attr("id"),
                left: parseInt($e.css("left")),
                top: parseInt($e.css("top")),
                width: $e.width(),
                height: $e.height(),
                zIndex: $e.css("z-index"),
                text: $e.find("textarea").val()
            };
        }

        function drawMarkdownFromData(data) {
            var item = addMarkdown();
            $(item)
                .attr("id", data.id)
                .css("left", data.left)
                .css("top", data.top)
                .width(data.width)
                .height(data.height)
                .css("z-index", data.zIndex)
                .find("textarea").val(data.text);
            $(item).find("a.md-view").trigger("click");
        }

        function importDataFromJson(json) {
            importDataFromData(JSON.parse(json));
        }

        function importDataFromData(data) {
            isRecordEvents = false;
            try {
                $(".canvas-item:visible").remove();

                $("#canvas-width").val(data.canvas.width);
                $("#canvas-height").val(data.canvas.height);
                setCanvasSize();

                for (var i = 0; i < data.items.length; i++) {
                    importItem(data.items[i]);
                }

                // adjust z-index
                for (var i = 0; i < data.items.length; i++) {
                    const item = data.items[i];
                    $("#" + item.id).css("z-index", item.zIndex);
                }

            } finally {
                isRecordEvents = true;
            }
            clearEventStore();
            clearForwardStore();
        }

        function importItem(item) {
            isRecordEvents = false;
            try {
                if (item.type == "sticky-note") {
                    drawStickyNoteFromData(item);
                } else if (item.type == "vertical-line") {
                    drawVerticalLineFromData(item);
                } else if (item.type == "horizontal-line") {
                    drawHorizontalLineFromData(item);
                } else if (item.type == "image") {
                    drawImageFromData(item);
                } else if (item.type == "markdown") {
                    drawMarkdownFromData(item);
                }
            } finally {
                isRecordEvents = true;
            }
        }

        var isRecordEvents = true;
        const eventStore = {
            _store: [],
            push: function (event) {
                if (!event) {
                    return;
                }
                var normalizedEvent = Object.assign(event, {
                    id: cuid(),
                    publisherId: publisherId,
                    userName: getUserName(),
                    occuredOn: new Date()
                });
                if (!(normalizedEvent.forwardOnly)) {
                    this._store.push(normalizedEvent);
                }
                if (socket) {
                    socket.emit('do event', normalizedEvent);
                }
            },
            pop: function () {
                var event = this._store.pop();
                if (socket) {
                    socket.emit('undo event', event);
                }
                return event;
            },
            clear: function () {
                this._store.splice(0, eventStore._store.length);
            }
        };

        const forwardStore = {
            _store: [],
            push: function (msg) {
                this._store.push(msg);
            },
            pop: function () {
                var msg = this._store.pop();
                return msg;
            },
            clear: function () {
                this._store.splice(0, forwardStore._store.length);
            }
        };

        function undo() {
            const event = eventStore.pop();
            if (!event) {
                return;
            }
            for (var key in AppEvent) {
                const e = AppEvent[key];
                if (e.isTargetType && e.isTargetType(event)) {
                    e.back(event);
                    forwardStore.push(event);
                    return;
                }
            }
        }

        function redo() {
            const event = forwardStore.pop();
            if (!event) {
                return;
            }
            for (var key in AppEvent) {
                const e = AppEvent[key];
                if (e.isTargetType && e.isTargetType(event)) {
                    e.forward(event);
                    eventStore.push(event);
                    return;
                }
            }
        }

        function clearEventStore() {
            eventStore.clear();
        }

        function clearForwardStore() {
            forwardStore.clear();
        }

        const publisherId = cuid();

        const AppEvent = {
            AddItem: {
                publish: function (elem) {
                    if (!isRecordEvents) {
                        return;
                    }
                    eventStore.push({
                        eventType: "addItem",
                        eventBody: convertToDataForExport(elem)
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "addItem";
                },
                back: function (event) {
                    $("#" + event.eventBody.id).remove();
                },
                forward: function (event) {
                    importItem(event.eventBody);
                }
            },
            MoveItems: {
                publish: function (ids, oldPositions, moveLeft, moveTop) {
                    if (!isRecordEvents) {
                        return;
                    }
                    eventStore.push({
                        eventType: "moveItems",
                        eventBody: {
                            ids: ids,
                            oldPositions: oldPositions,
                            moveLeft: moveLeft,
                            moveTop: moveTop
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "moveItems";
                },
                back: function (event) {
                    event.eventBody.ids.forEach(function (id, i) {
                        const target = $("#" + id);
                        const left = parseInt(target.css("left"));
                        const top = parseInt(target.css("top"));
                        target.css("left", event.eventBody.oldPositions[i].left + "px");
                        target.css("top", event.eventBody.oldPositions[i].top + "px");
                    });
                },
                forward: function (event) {
                    const targets = [];
                    event.eventBody.ids.forEach(function (id, i) {
                        const target = $("#" + id);
                        targets.push(target);
                        const left = parseInt(event.eventBody.oldPositions[i].left);
                        const top = parseInt(event.eventBody.oldPositions[i].top);
                        target.css("left", left + event.eventBody.moveLeft);
                        target.css("top", top + event.eventBody.moveTop);
                    });
                },
            },
            ResizeItem: {
                publish: function (elem, oldWidth, oldHeight) {
                    if (!isRecordEvents) {
                        return;
                    }
                    eventStore.push({
                        eventType: "resizeItem",
                        eventBody: {
                            id: $(elem).attr("id"),
                            elementClass: $(elem).attr("class"),
                            from: {
                                width: oldWidth,
                                height: oldHeight
                            },
                            to: {
                                width: $(elem).width(),
                                height: $(elem).height()
                            }
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "resizeItem";
                },
                back: function (event) {
                    $("#" + event.eventBody.id)
                        .width(event.eventBody.from.width)
                        .height(event.eventBody.from.height);
                    if (event.eventBody.elementClass.indexOf("sticky-note") >= 0) {
                        adjustFontSize($("#" + event.eventBody.id).find("textarea"));
                    }
                },
                forward: function (event) {
                    const target = $("#" + event.eventBody.id)
                        .width(event.eventBody.to.width)
                        .height(event.eventBody.to.height);
                    if (event.eventBody.elementClass.indexOf("sticky-note") >= 0) {
                        adjustFontSize(target.find("textarea"));
                    }
                }
            },
            DeleteItems: {
                publish: function (elems) {
                    if (!isRecordEvents) {
                        return;
                    }
                    const datas = [];
                    $(elems).each(function (i, elem) {
                        datas.push(convertToDataForExport(elem));
                    });
                    eventStore.push({
                        eventType: "deleteItems",
                        eventBody: {
                            items: datas
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "deleteItems";
                },
                back: function (event) {
                    event.eventBody.items.forEach(function (item, i) {
                        importItem(item);
                    });
                },
                forward: function (event) {
                    event.eventBody.items.forEach(function (item, i) {
                        $("#" + item.id).remove();
                    });
                }
            },
            ChangeStickyNoteText: {
                publish: function (elem, old) {
                    if (!isRecordEvents) {
                        return;
                    }
                    eventStore.push({
                        eventType: "changeStickyNoteText",
                        eventBody: {
                            id: $(elem).attr("id"),
                            from: old,
                            to: $(elem).find("textarea").val()
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "changeStickyNoteText";
                },
                back: function (event) {
                    const target = $("#" + event.eventBody.id);
                    const textarea = target.find("textarea");
                    const text = event.eventBody.from;
                    textarea.val(text);
                    textarea.trigger("keydown");
                    updateTooltip(target, text);
                },
                forward: function (event) {
                    const target = $("#" + event.eventBody.id);
                    const textarea = target.find("textarea");
                    const text = event.eventBody.to;
                    textarea.val(text);
                    textarea.trigger("keydown");
                    updateTooltip(target, text);
                }
            },
            ChangeStickyNotesColor: {
                publish: function (elems, froms, to) {
                    if (!isRecordEvents) {
                        return;
                    }
                    const ids = [];
                    $(elems).each(function (i, elem) {
                        ids.push($(elem).attr("id"));
                    });
                    eventStore.push({
                        eventType: "changeStickyNotesColor",
                        eventBody: {
                            ids: ids,
                            froms: froms,
                            to: to
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "changeStickyNotesColor";
                },
                back: function (event) {
                    event.eventBody.ids.forEach(function (id, i) {
                        const target = $("#" + id);
                        removeColorClass(target);
                        target.addClass(event.eventBody.froms[i]);
                    });
                },
                forward: function (event) {
                    event.eventBody.ids.forEach(function (id, i) {
                        const target = $("#" + id);
                        removeColorClass(target);
                        target.addClass(event.eventBody.to);
                    });
                }
            },
            ChangeMarkdownText: {
                publish: function (elem, old) {
                    if (!isRecordEvents) {
                        return;
                    }
                    eventStore.push({
                        eventType: "changeMarkdownText",
                        eventBody: {
                            id: $(elem).attr("id"),
                            from: old,
                            to: $(elem).find("textarea").val()
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "changeMarkdownText";
                },
                back: function (event) {
                    const target = $("#" + event.eventBody.id);
                    const textarea = target.find("textarea");
                    const text = event.eventBody.from;
                    textarea.val(text);
                    setMarkdownTextData(target, text);
                    target.find("a.md-view").trigger("click");
                },
                forward: function (event) {
                    const target = $("#" + event.eventBody.id);
                    const textarea = target.find("textarea");
                    const text = event.eventBody.to;
                    textarea.val(text);
                    setMarkdownTextData(target, text);
                    target.find("a.md-view").trigger("click");
                }
            },
            Push: {
                publish: function () {
                    confirmYesNo("あなたの表示内容で他のメンバーに上書きさせますか?", function () {
                        const data = createExportData();
                        eventStore.push({
                            eventType: "push",
                            eventBody: data,
                            forwardOnly: true,
                        });
                    });
                },
                isTargetType: function (event) {
                    return event.eventType == "push";
                },
                back: function () { },
                forward: function (event) {
                    confirmYesNo(event.userName + "から送らられてきた内容で上書きしますか?", function () {
                        importDataFromData(event.eventBody);
                    });
                }
            },
            Notify: {
                publish: function (msg) {
                    eventStore.push({
                        eventType: "notify",
                        eventBody: { msg: msg },
                        forwardOnly: true
                    });
                },
                isTargetType: function (event) {
                    return event.eventType == "notify";
                },
                permitMyself: function () {
                    return true;
                },
                back: function () { },
                forward: function (event) {
                    $.notify({
                        message: " " + event.userName,
                        icon: event.eventBody.msg
                    }, {
                        allow_dismiss: true,
                        type: "info",
                        offset: {
                            x: 10,
                            y: $("#menu").innerHeight() + 70
                        },
                        spacing: 3,
                        delay: 10000
                    });
                }
            },
            MoveMouse: {
                publish(x, y) {
                    eventStore.push({
                        eventType: "moveMouse",
                        eventBody: {
                            x: x,
                            y: y
                        },
                        forwardOnly: true
                    });
                },
                isTargetType: function (event) {
                    return event.eventType == "moveMouse";
                },
                back: function () { },
                forward: function (event) {
                    const pointerId = "pointer-" + event.publisherId;
                    var pointer = $("#" + pointerId);
                    if (pointer.length < 1) {
                        var pointer = $("<div></div>");
                        pointer.addClass("pointer");
                        pointer.attr("id", "pointer-" + event.publisherId);
                        pointer.append("<p class='name'></p>");
                        $("body").append(pointer);
                    }
                    $(pointer).find(".name").text(event.userName);
                    pointer.offset({
                        left: event.eventBody.x * currentScale,
                        top: $("#menu").outerHeight() + (event.eventBody.y *
                            currentScale)
                    });
                }
            },
            SendToFront: {
                publish: function (ids, oldZIndexes) {
                    if (!isRecordEvents) {
                        return;
                    }
                    eventStore.push({
                        eventType: "sendToFront",
                        eventBody: {
                            ids: ids,
                            oldZIndexes: oldZIndexes
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "sendToFront";
                },
                back: function (event) {
                    let targets = $(event.eventBody.ids).map((i, id) => $("#" + id)[0]);
                    const sortedItems = $("#canvas .canvas-item").not(targets).sort(compareByZIndex);
                    targets.each((i, v) => {
                        sortedItems.splice(event.eventBody.oldZIndexes[i], 0, v);
                    });
                    sortedItems.each((i, v) => {
                        $(v).css("z-index", i);
                    });
                },
                forward: function (event) {
                    const targets = $(event.eventBody.ids).map((i, id) => $("#" + id));
                    toFrontMostItems(targets);
                }
            },
            SendToBack: {
                publish: function (ids, oldZIndexes) {
                    if (!isRecordEvents) {
                        return;
                    }
                    eventStore.push({
                        eventType: "sendToBack",
                        eventBody: {
                            ids: ids,
                            oldZIndexes: oldZIndexes
                        }
                    });
                    clearForwardStore();
                },
                isTargetType: function (event) {
                    return event.eventType == "sendToBack";
                },
                back: function (event) {
                    AppEvent.SendToFront.back(event);
                },
                forward: function (event) {
                    const targets = $(event.eventBody.ids).map((i, id) => $("#" + id));
                    toBackMostItems(targets);
                }
            }

        };

        function setupShortcutKeys() {
            $(window).on("keydown", function (e) {
                const _isFocusOnBody = isFocusOnBody();
                if (navigator.platform.indexOf("Mac") >= 0) {
                    // delete (deleteItem)
                    if (_isFocusOnBody && isTargetKeyEvent(e, false, false, false, false, 8)) {
                        e.preventDefault();
                        deleteItem();
                    }
                    // command(meta)+z (undo)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, false, false, false, true,
                        90)) {
                        e.preventDefault();
                        undo();
                    }
                    // command(meta)+shift+z (redo)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, false, true, false, true, 90)) {
                        e.preventDefault();
                        redo();
                    }
                    // command(meta)+a (select all)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, false, false, false, true,
                        65)) {
                        e.preventDefault();
                        $(".canvas-item:visible").addClass("ui-selected");
                    }
                    // escape (deselect all)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, false, false, false, false,
                        27)) {
                        e.preventDefault();
                        $(document.body).focus();
                        $(".canvas-item:visible").removeClass("ui-selected");
                    }
                    // command(meta)+s (export)
                    else if (isTargetKeyEvent(e, false, false, false, true, 83)) {
                        e.preventDefault();
                        $(document.body).focus();
                        exportData();
                    }
                    // command(meta)+o (import)
                    else if (isTargetKeyEvent(e, false, false, false, true, 79)) {
                        e.preventDefault();
                        $(document.body).focus();
                        importData();
                    }
                } else {
                    // delete (deleteItem)
                    if (_isFocusOnBody && isTargetKeyEvent(e, false, false, false, false, 46)) {
                        e.preventDefault();
                        deleteItem();
                    }
                    // ctrl+z (undo)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, true, false, false, false,
                        90)) {
                        e.preventDefault();
                        undo();
                    }
                    // ctrl+y (redo)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, true, false, false, false,
                        89)) {
                        e.preventDefault();
                        redo();
                    }
                    // ctrl+a (select all)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, true, false, false, false,
                        65)) {
                        e.preventDefault();
                        $(".canvas-item:visible").addClass("ui-selected");
                    }
                    // escape (deselect all)
                    else if (_isFocusOnBody && isTargetKeyEvent(e, false, false, false, false,
                        27)) {
                        e.preventDefault();
                        $(document.body).focus();
                        $(".canvas-item:visible").removeClass("ui-selected");
                    }
                    // ctrl+s (export)
                    else if (isTargetKeyEvent(e, true, false, false, false, 83)) {
                        e.preventDefault();
                        $(document.body).focus();
                        exportData();
                    }
                    // ctrl+o (import)
                    else if (isTargetKeyEvent(e, true, false, false, false, 79)) {
                        e.preventDefault();
                        $(document.body).focus();
                        importData();
                    }
                }
            });
        }

        function isTargetKeyEvent(e, isCtrlKey, isShiftKey, isAltKey, isMetaKey, keyCode) {
            return e.ctrlKey == isCtrlKey &&
                e.shiftKey == isShiftKey &&
                e.altKey == isAltKey &&
                e.metaKey == isMetaKey &&
                e.keyCode == keyCode;
        }

        function isFocusOnBody() {
            return document.activeElement.tagName == "BODY" ||
                document.activeElement.tagName == "BUTTON";
        }

        var socket;

        function setupWebsocket(roomId) {
            if (window["io"]) {
                return;
            }
            $.getScript(config.socketioServer + config.socketioScript, () => {
                socket = io(config.socketioServer + '/?roomId=' + roomId);
                socket.on('do event', function (event) {
                    //console.log(event);
                    for (var key in AppEvent) {
                        const e = AppEvent[key];
                        if (e.isTargetType && e.isTargetType(event)) {
                            if (event.publisherId == publisherId) {
                                if (!e.permitMyself) {
                                    continue;
                                }
                            }
                            e.forward(event);
                            return;
                        }
                    }
                });
                socket.on('undo event', function (event) {
                    if (!event) {
                        return;
                    }
                    //console.log(event);
                    for (var key in AppEvent) {
                        const e = AppEvent[key];
                        if (e.isTargetType && e.isTargetType(event)) {
                            if (event.publisherId == publisherId) {
                                if (!e.permitMyself) {
                                    continue;
                                }
                            }
                            e.back(event);
                            return;
                        }
                    }
                });
            });
        }

        function getCurrentRoomId() {
            var roomId = null;
            var query = location.search;
            var preRoomIdWord = "roomId=";
            var idx = query.indexOf(preRoomIdWord);
            if (idx > 0) {
                var temp = query.substring(idx + preRoomIdWord.length);
                var ampIdx = temp.indexOf("&");
                if (ampIdx > 0) {
                    roomId = temp.substring(0, ampIdx);
                } else {
                    roomId = temp;
                }
            }
            return roomId;
        }

        function initRoom(roomIdParam) {
            const currentRoomId = getCurrentRoomId();
            var roomId;
            if (currentRoomId) {
                if (roomIdParam) {
                    if (currentRoomId != roomIdParam) {
                        // should be reload
                        history.replaceState("", "", "?roomId=" + roomIdParam);
                        location.href = location.href;
                        return;
                    }
                } else {
                    roomId = currentRoomId;
                }
            } else {
                if (roomIdParam) {
                    roomId = roomIdParam;
                }
            }
            if (roomId) {
                history.replaceState("", "", "?roomId=" + roomId);
                showUserNameInputDialog();
                setupWebsocket(roomId);
                showGroupWorkMenu();
            }
        }

        function showUserNameInputDialog() {
            inputWithDialog("あなたの名前", function (userName) {
                if (userName == null || userName == "") {
                    return false;
                }
                $("#user-name").val(userName);
                return true;
            });
        }

        function inputWithDialog(title, callbackOfYes) {
            $("#input-dialog .modal-title").text(title);
            $("#input-dialog .yes").on("click", function () {
                if (callbackOfYes($("#input-box").val())) {
                    $("#input-dialog").modal("hide");
                }
            });
            $("#input-dialog form").on("submit", function () {
                $("#input-dialog .yes").click();
                return false;
            });
            $("#input-dialog").modal();
            $("#input-dialog").on("shown.bs.modal", function (e) {
                $("#input-box").focus();
            });
        }

        function showGroupWorkMenu() {
            $("#user-name,#push-button,#clear-pointers-button").removeClass("d-none");
            $("#reaction-buttons").removeClass("d-none");
        }

        function createRoom() {
            const roomId = cuid();
            initRoom(roomId);
        }

        function push() {
            AppEvent.Push.publish();
        }

        function confirmYesNo(message, callbackOfYes) {
            $("#yesno-dialog .modal-body").text(message);
            $("#yesno-dialog .yes").one("click", function () {
                callbackOfYes();
                $("#yesno-dialog").modal("hide");
            });
            $("#yesno-dialog").modal();
        }

        function syncMousePosition(event) {
            const x = (window.scrollX + event.clientX) / currentScale;
            const y = ((window.scrollY + event.clientY) / currentScale) - $("#menu").outerHeight();
            AppEvent.MoveMouse.publish(x, y);
        }

        function clearPointers() {
            $(".pointer").remove();
        }

        function getUserName() {
            return $("input.user-name").val();
        }

        function notify(msg) {
            AppEvent.Notify.publish(msg)
        }


        function compareByZIndex(a, b) {
            let ai = parseInt($(a).css("z-index"));
            if (isNaN(ai)) {
                ai = 0;
            }
            let bi = parseInt($(b).css("z-index"));
            if (isNaN(bi)) {
                bi = 0;
            }
            return ai - bi;
        }

        function moveIndex(sortedItems, targetIndex, toIndex) {
            if (targetIndex == toIndex) {
                return;
            }
            const target = sortedItems[targetIndex];
            sortedItems.splice(targetIndex, 1);
            sortedItems.splice(toIndex, 0, target);
        }

    </script>
</body>

</html>